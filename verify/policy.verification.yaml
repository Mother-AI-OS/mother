# Mother AI OS - Verification Test Policy
# This policy is used by the verification harness to test safety controls.
#
# Key properties:
#   - Safe mode: ON (blocks high-risk by default)
#   - Filesystem: READ/WRITE allowed only in ./workspace
#   - Filesystem: DELETE blocked
#   - Shell: All commands blocked
#   - Network: External fetches blocked
#   - Audit: Full logging with redaction
#
# Usage:
#   export MOTHER_POLICY_PATH=./verify/policy.verification.yaml
#   export MOTHER_MOCK_LLM=1
#   mother serve

version: "1.0"
name: "verification-test"
description: "Strict policy for verification testing - tests safety controls"

# Enable safe mode - blocks high-risk operations by default
safe_mode: true

# Default deny - explicit rules required
default_action: deny

rules:
  # Allow filesystem read in workspace only
  - name: allow-workspace-read
    description: "Allow reading files in workspace directory"
    capability_pattern: "filesystem_read"
    action: allow
    priority: 100
    conditions:
      param.path:
        regex: "^\\./workspace/.*|^workspace/.*"

  # Allow filesystem write in workspace only
  - name: allow-workspace-write
    description: "Allow writing files in workspace directory"
    capability_pattern: "filesystem_write"
    action: allow
    priority: 100
    conditions:
      param.path:
        regex: "^\\./workspace/.*|^workspace/.*"

  # Allow filesystem list in workspace only
  - name: allow-workspace-list
    description: "Allow listing workspace directory"
    capability_pattern: "filesystem_list"
    action: allow
    priority: 100
    conditions:
      param.path:
        regex: "^\\./workspace/?$|^workspace/?$|^\\./workspace/.*|^workspace/.*"

  # Allow filesystem search in workspace only
  - name: allow-workspace-search
    description: "Allow searching in workspace directory"
    capability_pattern: "filesystem_search"
    action: allow
    priority: 100
    conditions:
      param.path:
        regex: "^\\./workspace/?$|^workspace/?$|^\\./workspace/.*|^workspace/.*"

  # Allow task operations (safe, no external effects)
  - name: allow-tasks
    description: "Allow all task management operations"
    capability_pattern: "tasks_.*"
    action: allow
    priority: 100

  # DENY: Filesystem delete (test policy enforcement)
  - name: deny-delete
    description: "Block all file deletion"
    capability_pattern: "filesystem_delete"
    action: deny
    priority: 200

  # DENY: All shell commands
  - name: deny-shell
    description: "Block all shell command execution"
    capability_pattern: "shell_.*"
    action: deny
    priority: 200

  # DENY: Network external access
  - name: deny-network
    description: "Block all external network access"
    capability_pattern: "web_.*"
    action: deny
    priority: 200

  # DENY: Email operations
  - name: deny-email
    description: "Block all email operations"
    capability_pattern: "email_.*"
    action: deny
    priority: 200

  # DENY: Tor operations
  - name: deny-tor
    description: "Block all Tor operations"
    capability_pattern: "tor_.*"
    action: deny
    priority: 200

  # Allow health/status checks
  - name: allow-status
    description: "Allow status and health checks"
    capability_pattern: "(health|status|tools)_.*"
    action: allow
    priority: 50

filesystem:
  # Only allow workspace directory
  allowed_paths:
    - "./workspace/**"
    - "workspace/**"

  # Block everything else
  denied_paths:
    - "/etc/**"
    - "/var/**"
    - "/home/**"
    - "/root/**"
    - "~/**"
    - "../**"

  read_only_paths: []
  allow_symlinks: false
  max_file_size: 10485760  # 10MB limit for tests

commands:
  # Block all commands
  allowed_commands: []
  denied_commands:
    - ".*"
  denied_patterns:
    - ".*"
  allowed_cwd:
    - "./workspace"
  max_timeout: 10
  allow_pipes: false
  allow_redirects: false

network:
  # Block all external domains
  allowed_domains: []
  denied_domains:
    - "*"
  allowed_ips: []
  denied_ips:
    - "*"
  block_private_ranges: true
  allowed_ports: []
  denied_ports:
    - "*"
  max_request_size: 0
  max_response_size: 0

data:
  max_classification: internal
  block_exfiltration: true
  sensitive_patterns:
    - "sk-ant-.*"
    - "sk-[a-zA-Z0-9]+"
    - "AKIA[A-Z0-9]+"
    - "password"
    - "secret"
  allowed_export_domains: []

audit:
  enabled: true
  log_path: "./logs/audit.jsonl"
  include_params: true
  redact_sensitive: true
  retention_days: 1
